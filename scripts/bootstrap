#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=scripts/lib/common.sh
source "${SCRIPT_DIR}/lib/common.sh"

ensure_python

VENV_PATH="${PROJECT_ROOT}/.venv"
if [[ ! -d "${VENV_PATH}" ]]; then
  _log "Creating virtual environment at ${VENV_PATH}"
  "${PYTHON_BIN}" -m venv "${VENV_PATH}"
fi

# shellcheck disable=SC1091
source "${VENV_PATH}/bin/activate"

_log "Upgrading pip and wheel"
python -m pip install --upgrade pip wheel

_log "Installing project dependencies"
pip install -e '.[dev,server,crypto,docs]'

if [[ -f "${PROJECT_ROOT}/requirements-dev.txt" ]]; then
  pip install -r "${PROJECT_ROOT}/requirements-dev.txt"
fi

if [[ -f "${PROJECT_ROOT}/package.json" ]]; then
  check_command npm
  _log "Installing Node.js dependencies"
  npm install --no-audit --no-fund
fi

if command -v pre-commit >/dev/null 2>&1; then
  _log "Installing pre-commit hooks"
  pre-commit install --install-hooks
fi

_log "Bootstrap complete"
