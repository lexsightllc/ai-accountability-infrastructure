#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=scripts/lib/common.sh
source "${SCRIPT_DIR}/lib/common.sh"

ensure_python
ensure_venv

_log "Running pip-audit"
check_command python
run_python -m pip_audit ${PIP_AUDIT_ARGS:-}

if has_npm_script "security-scan"; then
  (cd "${PROJECT_ROOT}" && npm run security-scan)
elif [[ -f "${PROJECT_ROOT}/package-lock.json" ]]; then
  _log "Running npm audit"
  check_command npm
  (cd "${PROJECT_ROOT}" && npm audit --audit-level=${NPM_AUDIT_LEVEL:-moderate})
fi

if command -v trivy >/dev/null 2>&1 && [[ -f "${PROJECT_ROOT}/Dockerfile" ]]; then
  _log "Running Trivy filesystem scan"
  trivy fs --exit-code 1 --severity HIGH,CRITICAL "${PROJECT_ROOT}"
fi
